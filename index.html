<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Aventura de las Manzanas</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sky-top: #4facfe;
            --sky-bottom: #00f2fe;
            --grass: #43e97b;
            --dirt: #38f9d7;
            --ui-bg: rgba(255, 255, 255, 0.8);
        }

        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(to bottom, var(--sky-top), var(--sky-bottom));
            font-family: 'Fredoka One', cursive;
            touch-action: none; /* Previene zoom y scroll en m√≥viles */
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            pointer-events: none; /* Deja pasar los clicks al juego */
            z-index: 10;
        }

        .hud-panel {
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 1.2rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .heart { color: #ff4757; }
        .apple-icon { color: #ff6b81; }

        /* Pantallas (Men√∫, Game Over, Win) */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            color: white;
            text-align: center;
            backdrop-filter: blur(5px);
            transition: opacity 0.5s;
        }

        .hidden { display: none !important; }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            color: #ffd700;
            text-shadow: 0 5px 0 #d35400;
            letter-spacing: 2px;
        }

        p.story {
            font-family: 'Nunito', sans-serif;
            font-size: 1.2rem;
            max-width: 80%;
            line-height: 1.5;
            margin-bottom: 30px;
        }

        button.btn-start {
            background: linear-gradient(to bottom, #ff9f43, #ee5253);
            border: none;
            padding: 15px 50px;
            font-size: 1.5rem;
            color: white;
            font-family: 'Fredoka One', cursive;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 0 #b33939, 0 10px 20px rgba(0,0,0,0.4);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        button.btn-start:active {
            transform: translateY(5px);
            box-shadow: 0 5px 0 #b33939;
        }

        /* Canvas */
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Animaci√≥n de tutorial */
        .tutorial-hint {
            position: absolute;
            bottom: 20%;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 1.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: bounce 2s infinite;
            pointer-events: none;
        }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    </style>
</head>
<body>

    <div id="game-container">
        <div id="ui-layer" class="hidden">
            <div class="hud-panel">
                <span class="apple-icon">üçé</span> <span id="score-display">0 / 10</span>
            </div>
            <div class="hud-panel">
                Nivel <span id="level-display" style="margin-left:5px">1</span>
            </div>
            <div class="hud-panel">
                <span class="heart" id="lives-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
            </div>
        </div>

        <div id="start-screen" class="screen">
            <h1>LA AVENTURA<br>DEL MANZANO</h1>
            <p class="story">
                ¬°Hola! Ayuda a la ni√±a a recoger manzanas m√°gicas.<br>
                Salta para agarrarlas y evita a los gusanos gru√±ones.<br>
                <br>
                ‚≠ê Toca 1 vez para saltar.<br>
                ‚≠ê‚≠ê Toca 2 veces para saltar m√°s alto.
            </p>
            <button class="btn-start" onclick="initGame()">¬°JUGAR!</button>
        </div>

        <div id="level-screen" class="screen hidden">
            <h1 style="color: #43e97b;">¬°MUY BIEN!</h1>
            <p class="story" id="level-msg">Nivel completado.</p>
            <button class="btn-start" onclick="nextLevel()">Siguiente Nivel ‚û°</button>
        </div>

        <div id="gameover-screen" class="screen hidden">
            <h1 style="color: #ff4757;">¬°OH NO!</h1>
            <p class="story">Los bichos te han atrapado.</p>
            <button class="btn-start" onclick="restartGame()">Intentar de Nuevo ‚Ü∫</button>
        </div>

        <div id="win-screen" class="screen hidden">
            <h1>¬°GANASTE! üèÜ</h1>
            <p class="story">¬°Juntaste todas las manzanas y hiciste el pastel m√°s rico del mundo!</p>
            <button class="btn-start" onclick="location.reload()">Jugar Otra Vez</button>
        </div>

        <div id="tutorial" class="tutorial-hint hidden">Toc√° la pantalla para saltar</div>

        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        // --- MOTOR DE AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'jump') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(500, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'collect') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(1000, now);
                osc.frequency.setValueAtTime(1500, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'win') {
                osc.type = 'square';
                // Melodia simple
                [523, 659, 784, 1046].forEach((f, i) => {
                    let o = audioCtx.createOscillator();
                    let g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0.1, now + i*0.1);
                    g.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.4);
                    o.start(now + i*0.1); o.stop(now + i*0.1 + 0.4);
                });
            }
        }

        // --- L√ìGICA DEL JUEGO ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let animationId;
        let gameRunning = false;
        let frames = 0;

        // Configuraci√≥n de Juego
        const gameState = {
            level: 1,
            applesCollected: 0,
            lives: 3,
            goal: 5,
            enemySpeed: 3
        };

        // Entidades
        const player = {
            x: 50,
            y: 0,
            width: 60,
            height: 80,
            dy: 0,
            jumpPower: -18,
            gravity: 0.9,
            grounded: false,
            doubleJump: false,
            emoji: 'üëß'
        };

        let apples = [];
        let enemies = [];
        let particles = [];
        let groundHeight = 100;

        // Niveles
        const levels = [
            { goal: 5, enemySpeed: 4, msg: "Nivel 1: El Jard√≠n Amanece", enemyType: 'üêõ', spawnRate: 200 },
            { goal: 10, enemySpeed: 6, msg: "Nivel 2: Gusanos R√°pidos", enemyType: 'üêõ', spawnRate: 150 },
            { goal: 15, enemySpeed: 7, msg: "Nivel 3: ¬°Cuidado con las Ara√±as!", enemyType: 'üï∑Ô∏è', spawnRate: 120 }
        ];

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            groundHeight = height - 100;
        }
        window.addEventListener('resize', resize);
        resize();

        // Input
        function handleJump(e) {
            if (!gameRunning) return;
            // e.preventDefault(); // Evitar comportamientos extra√±os
            
            if (player.grounded) {
                player.dy = player.jumpPower;
                player.grounded = false;
                player.doubleJump = true;
                playSound('jump');
            } else if (player.doubleJump) {
                player.dy = player.jumpPower * 0.8;
                player.doubleJump = false;
                playSound('jump');
                // Efecto particula salto doble
                createParticles(player.x + player.width/2, player.y + player.height, '#fff', 5);
            }
        }

        window.addEventListener('touchstart', handleJump);
        window.addEventListener('mousedown', handleJump);
        window.addEventListener('keydown', (e) => { if(e.code === 'Space') handleJump() });

        function initGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            document.getElementById('tutorial').classList.remove('hidden');
            gameState.level = 1;
            gameState.lives = 3;
            startLevel(1);
        }

        function startLevel(lvl) {
            const config = levels[lvl - 1];
            gameState.level = lvl;
            gameState.goal = config.goal;
            gameState.applesCollected = 0;
            gameState.enemySpeed = config.enemySpeed;
            
            // Reset Entidades
            apples = [];
            enemies = [];
            particles = [];
            player.y = groundHeight - player.height;
            player.dy = 0;
            
            updateHUD();
            
            gameRunning = true;
            loop();

            setTimeout(() => document.getElementById('tutorial').classList.add('hidden'), 3000);
        }

        function nextLevel() {
            document.getElementById('level-screen').classList.add('hidden');
            if (gameState.level >= levels.length) {
                document.getElementById('win-screen').classList.remove('hidden');
                document.getElementById('ui-layer').classList.add('hidden');
                playSound('win');
            } else {
                startLevel(gameState.level + 1);
            }
        }

        function restartGame() {
            document.getElementById('gameover-screen').classList.add('hidden');
            gameState.lives = 3;
            startLevel(1);
        }

        function updateHUD() {
            document.getElementById('score-display').innerText = `${gameState.applesCollected} / ${gameState.goal}`;
            document.getElementById('level-display').innerText = gameState.level;
            document.getElementById('lives-display').innerText = '‚ù§Ô∏è'.repeat(gameState.lives);
        }

        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1.0,
                    color: color
                });
            }
        }

        function spawnApple() {
            // Manzanas aparecen a diferentes alturas
            const isHigh = Math.random() > 0.5;
            const yPos = isHigh ? groundHeight - 200 : groundHeight - 120; // Alta o Baja
            apples.push({
                x: width,
                y: yPos,
                size: 40,
                speed: 4 // La escena se mueve hacia la izquierda
            });
        }

        function spawnEnemy() {
            const config = levels[gameState.level - 1];
            enemies.push({
                x: width,
                y: groundHeight - 50, // En el suelo
                width: 50,
                height: 50,
                speed: config.enemySpeed + Math.random(),
                emoji: config.enemyType
            });
        }

        function checkCollision(rect1, rect2) {
            return (rect1.x < rect2.x + rect2.width &&
                    rect1.x + rect1.width > rect2.x &&
                    rect1.y < rect2.y + rect2.height &&
                    rect1.y + rect1.height > rect2.y);
        }

        function loop() {
            if (!gameRunning) return;
            animationId = requestAnimationFrame(loop);
            ctx.clearRect(0, 0, width, height);
            frames++;

            const levelConfig = levels[gameState.level - 1];

            // 1. Dibujar Fondo (√Årboles Parallax Simple)
            // Tronco
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(100, 0, 100, height); 
            // Hojas
            ctx.fillStyle = '#2ecc71';
            ctx.beginPath();
            ctx.arc(150, 100, 200, 0, Math.PI * 2);
            ctx.fill();
            
            // Suelo
            ctx.fillStyle = '#43e97b';
            ctx.fillRect(0, groundHeight, width, height - groundHeight);
            // Linea decorativa suelo
            ctx.strokeStyle = '#27ae60';
            ctx.lineWidth = 10;
            ctx.beginPath();
            ctx.moveTo(0, groundHeight);
            ctx.lineTo(width, groundHeight);
            ctx.stroke();

            // 2. F√≠sica Jugador
            player.dy += player.gravity;
            player.y += player.dy;

            if (player.y + player.height > groundHeight) {
                player.y = groundHeight - player.height;
                player.dy = 0;
                player.grounded = true;
            }

            // Dibujar Jugador
            ctx.font = '60px Arial';
            ctx.textAlign = 'center';
            // Efecto de rebote al saltar
            let bounceY = player.grounded ? 0 : -5;
            ctx.fillText(player.emoji, player.x + player.width/2, player.y + player.height + bounceY);

            // 3. Gestionar Manzanas
            // Spawn
            if (frames % 100 === 0) spawnApple();

            for (let i = apples.length - 1; i >= 0; i--) {
                let a = apples[i];
                a.x -= a.speed;

                // Dibujar Manzana
                ctx.font = '40px Arial';
                ctx.fillText('üçé', a.x + 20, a.y + 30);
                
                // Colisi√≥n (C√≠rculo simple)
                let dx = (player.x + player.width/2) - (a.x + 20);
                let dy = (player.y + player.height/2) - (a.y + 30);
                let distance = Math.sqrt(dx*dx + dy*dy);

                if (distance < 50) {
                    // Recogida
                    playSound('collect');
                    createParticles(a.x, a.y, '#ff6b81', 10);
                    apples.splice(i, 1);
                    gameState.applesCollected++;
                    updateHUD();

                    if (gameState.applesCollected >= gameState.goal) {
                        gameRunning = false;
                        document.getElementById('level-msg').innerText = `¬°Bien hecho! Recogiste ${gameState.goal} manzanas.`;
                        document.getElementById('level-screen').classList.remove('hidden');
                        playSound('win');
                    }
                    continue;
                }

                if (a.x < -50) apples.splice(i, 1);
            }

            // 4. Gestionar Enemigos
            // Spawn aleatorio
            if (frames % levelConfig.spawnRate === 0) spawnEnemy();

            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                e.x -= e.speed;

                // Dibujar Enemigo
                ctx.font = '50px Arial';
                ctx.fillText(e.emoji, e.x + 25, e.y + 45);

                // Colisi√≥n (Caja)
                if (checkCollision(player, {x: e.x, y: e.y, width: 40, height: 40})) {
                    playSound('hit');
                    createParticles(player.x, player.y, '#ff0000', 15);
                    enemies.splice(i, 1);
                    gameState.lives--;
                    updateHUD();

                    if (gameState.lives <= 0) {
                        gameRunning = false;
                        document.getElementById('gameover-screen').classList.remove('hidden');
                    }
                    continue;
                }

                if (e.x < -50) enemies.splice(i, 1);
            }

            // 5. Particulas
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1.0;

                if (p.life <= 0) particles.splice(i, 1);
            }
        }
    </script>
</body>
</html>